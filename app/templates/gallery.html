{% extends "base.html" %} {% block title %}Premium Gallery - x402 Demo{%
endblock %} {% block styles %}
<style>
  /* Masonry (Unsplash-like) */
  .masonry {
    column-count: 4;
    column-gap: 1rem;
    width: 100%;
  }
  @media (max-width: 992px) {
    .masonry {
      column-count: 3;
    }
  }
  @media (max-width: 768px) {
    .masonry {
      column-count: 2;
    }
  }
  @media (max-width: 576px) {
    .masonry {
      column-count: 1;
    }
  }

  .masonry-item {
    break-inside: avoid;
    margin-bottom: 1rem;
  }
  .photo-card {
    border-radius: 10px;
    overflow: hidden;
    background: #fff;
    box-shadow: 0 6px 18px rgba(20, 20, 20, 0.06);
    transition: transform 0.18s ease;
  }
  .photo-card:hover {
    transform: translateY(-6px);
  }
  .photo-card img {
    width: 100%;
    display: block;
    object-fit: cover;
  }

  .card-meta {
    padding: 0.6rem 0.75rem;
  }
  .title {
    font-weight: 600;
    font-size: 0.95rem;
  }
  .meta-small {
    font-size: 0.78rem;
    color: #6c757d;
  }

  /* skeleton */
  .skeleton {
    width: 100%;
    height: 220px;
    border-radius: 10px;
    background: linear-gradient(90deg, #eee, #ddd, #eee);
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }

  .fallback {
    background: #f7f7f7;
    height: 220px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    font-weight: 600;
    padding: 1rem;
  }
  .pagination {
    margin-top: 1rem;
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
  }
</style>
{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>ðŸŽ‰ Premium Photo Gallery</h2>
      <div>
        <button id="refreshBtn" class="btn btn-outline-primary me-2">
          ðŸ”„ Refresh
        </button>
        <select
          id="pageSizeSelect"
          class="form-select d-inline-block"
          style="width: auto"
        >
          <option value="12">12</option>
          <option value="24" selected>24</option>
          <option value="48">48</option>
        </select>
      </div>
    </div>

    <div id="galleryRoot">
      <div
        id="masonry"
        class="masonry"
        role="list"
        aria-label="Photo gallery"
      ></div>

      <div class="pagination" id="paginationControls">
        <button id="prevBtn" class="btn btn-sm btn-secondary" disabled>
          Previous
        </button>
        <div id="pageInfo" class="mx-2 small text-muted">Page 1</div>
        <button id="nextBtn" class="btn btn-sm btn-secondary">Next</button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  /* Reusable Gallery Component
   Usage:
     Gallery.init({
       target: "#masonry",
       pageSize: 24,
       initialData: [...], // optional
       apiUrl: "/photos"
     });
*/
  const Gallery = (function () {
    let targetEl,
      pageSize = 24,
      data = [],
      page = 1,
      apiUrl = "/photos",
      isLoading = false;
    function init({
      target,
      pageSize: ps = 24,
      initialData = null,
      apiUrl: url = "/photos",
    } = {}) {
      targetEl = document.querySelector(target || "#masonry");
      pageSize = parseInt(ps, 10) || 24;
      apiUrl = url;
      page = 1;
      if (initialData && Array.isArray(initialData) && initialData.length) {
        data = initialData;
        renderPage();
      } else {
        loadAndRender();
      }
      bindControls();
    }

    function bindControls() {
      document
        .getElementById("refreshBtn")
        ?.addEventListener("click", () => loadAndRender(true));
      document.getElementById("prevBtn")?.addEventListener("click", () => {
        if (page > 1) {
          page--;
          renderPage();
        }
      });
      document.getElementById("nextBtn")?.addEventListener("click", () => {
        page++;
        renderPage();
      });
      document
        .getElementById("pageSizeSelect")
        ?.addEventListener("change", (e) => {
          pageSize = parseInt(e.target.value, 10);
          page = 1;
          renderPage();
        });
    }

    function renderSkeletons(count = 8) {
      targetEl.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const it = document.createElement("div");
        it.className = "masonry-item";
        it.innerHTML = `<div class="skeleton"></div>`;
        targetEl.appendChild(it);
      }
    }

    function fallbackElement(title) {
      const d = document.createElement("div");
      d.className = "fallback";
      d.textContent = title || "Untitled";
      return d;
    }

    function createCard(photo) {
      const wrapper = document.createElement("div");
      wrapper.className = "masonry-item";
      const img = document.createElement("img");
      img.alt = photo.title || "";
      img.src = photo.thumbnailUrl || photo.url || "";
      img.loading = "lazy";
      img.onerror = function () {
        const f = fallbackElement(photo.title);
        wrapper.querySelectorAll("*").forEach((n) => n.remove());
        wrapper.appendChild(f);
      };
      const card = document.createElement("div");
      card.className = "photo-card";
      const meta = document.createElement("div");
      meta.className = "card-meta";
      meta.innerHTML = `<div class="title">${truncate(
        photo.title || "",
        60
      )}</div><div class="meta-small">Album ${photo.albumId || "-"} â€¢ ID ${
        photo.id || "-"
      }</div>`;
      card.appendChild(img);
      card.appendChild(meta);
      wrapper.appendChild(card);
      return wrapper;
    }

    function truncate(s, n) {
      if (!s) return "";
      return s.length > n ? s.slice(0, n) + "..." : s;
    }

    function renderPage() {
      if (!targetEl) return;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const pageItems = data && data.length ? data.slice(start, end) : [];
      // If page is beyond range, clamp
      if (start >= (data.length || 0) && data.length) {
        page = 1;
        renderPage();
        return;
      }

      targetEl.innerHTML = "";
      if (!pageItems.length) {
        // show friendly empty
        const empty = document.createElement("div");
        empty.className = "alert alert-light";
        empty.textContent = "No photos to display.";
        targetEl.appendChild(empty);
      } else {
        pageItems.forEach((p) => targetEl.appendChild(createCard(p)));
      }
      updatePaginationControls();
    }

    function updatePaginationControls() {
      const prev = document.getElementById("prevBtn");
      const next = document.getElementById("nextBtn");
      const info = document.getElementById("pageInfo");
      prev.disabled = page <= 1;
      // Disable next if we've reached the end
      if (data && data.length) {
        const totalPages = Math.ceil(data.length / pageSize) || 1;
        next.disabled = page >= totalPages;
        info.textContent = `Page ${page} of ${totalPages}`;
      } else {
        next.disabled = false;
        info.textContent = `Page ${page}`;
      }
    }

    async function loadAndRender(forceFetch = false) {
      // Use prefetched sessionStorage if present and not forcing a refresh
      if (!forceFetch) {
        try {
          const pre = sessionStorage.getItem("prefetchedPhotos");
          if (pre) {
            const parsed = JSON.parse(pre);
            if (Array.isArray(parsed) && parsed.length) {
              data = parsed;
              page = 1;
              renderPage();
              return;
            }
          }
        } catch (e) {
          console.warn("prefetch parse failed", e);
        }
      }

      renderSkeletons(10);
      isLoading = true;

      try {
        // try to fetch paginated server API if available; we call with page & limit for backend that supports it
        const resp = await fetch(`${apiUrl}?page=${page}&limit=${pageSize}`, {
          headers: { Accept: "application/json" },
        });
        if (!resp.ok) {
          // fallback: try plain endpoint without params
          const fallbackResp = await fetch(apiUrl, {
            headers: { Accept: "application/json" },
          });
          if (!fallbackResp.ok) throw new Error("Failed to fetch photos");
          data = await fallbackResp.json();
        } else {
          const json = await resp.json();
          // the backend might return { items: [...], totalPages: X, total: Y } or just an array
          if (Array.isArray(json)) data = json;
          else if (Array.isArray(json.items)) data = json.items;
          else if (Array.isArray(json.data)) data = json.data;
          else data = Array.isArray(json) ? json : [];
        }
        page = 1;
        renderPage();
      } catch (err) {
        targetEl.innerHTML = `<div class="alert alert-danger">Error loading images: ${
          err.message || err
        }</div>`;
        console.error(err);
      } finally {
        isLoading = false;
      }
    }

    return { init, loadAndRender, renderPage, getData: () => data };
  })();

  /* Boot gallery on page load: use prefetchedPhotos if present */
  document.addEventListener("DOMContentLoaded", () => {
    let initial = null;
    try {
      const pre = sessionStorage.getItem("prefetchedPhotos");
      if (pre) initial = JSON.parse(pre);
    } catch (e) {
      console.warn("Failed to parse prefetchedPhotos", e);
    }

    Gallery.init({
      target: "#masonry",
      pageSize:
        parseInt(document.getElementById("pageSizeSelect").value, 10) || 24,
      initialData: initial,
      apiUrl: "/photos",
    });
  });
</script>
{% endblock %}
