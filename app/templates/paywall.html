{% extends "base.html" %} {% block title %}Payment Required - x402 Demo{%
endblock %} {% block styles %}
<style>
  /* JSON Response Viewer Styles */
  .json-viewer {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1.5rem;
    border-radius: 8px;
    font-family: "Courier New", monospace;
    font-size: 0.9rem;
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
  }

  .json-viewer pre {
    margin: 0;
    color: #d4d4d4;
  }

  .json-key {
    color: #9cdcfe;
  }

  .json-string {
    color: #ce9178;
  }

  .json-number {
    color: #b5cea8;
  }

  .json-boolean {
    color: #569cd6;
  }

  .json-null {
    color: #808080;
  }

  .response-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }

  .copy-btn {
    font-size: 0.85rem;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
  }

  .status-verified {
    background: #d4edda;
    color: #155724;
  }

  .status-settled {
    background: #cce5ff;
    color: #004085;
  }
</style>
{% endblock %} {% block content %}
<div class="row justify-content-center my-5">
  <div class="col-12 col-md-10 col-lg-8">
    <div class="card shadow-lg border-0">
      <div class="card-header bg-gradient-primary text-black py-4">
        <div class="d-flex align-items-center">
          <div class="display-4 me-3">üíé</div>
          <div>
            <h4 class="mb-0">Premium Access Required</h4>
            <small class="text-light-50"
              >Secure payment by crypto ‚Äî fast & private</small
            >
          </div>
        </div>
      </div>

      <div class="card-body p-4">
        <!-- Payment Section -->
        <div id="paymentFlow">
          <!-- Price Breakdown -->
          <div class="alert alert-info mb-4">
            <div class="row g-2">
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <span>Content Price:</span>
                  <strong>{{ amount }} USDC</strong>
                </div>
              </div>
              <div class="col-12">
                <div class="d-flex justify-content-between text-muted small">
                  <span>+ Facilitator Fee:</span>
                  <span>$0.01 USDC</span>
                </div>
              </div>
              <div class="col-12">
                <hr class="my-2" />
              </div>
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <strong>Total Amount:</strong>
                  <strong class="text-primary"
                    >{{ (amount | float + 0.01) | round(2) }} USDC</strong
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Network Info -->
          <div class="row g-3 mb-3">
            <div class="col-6">
              <div class="border rounded p-3 text-center">
                <small class="text-muted">Network</small>
                <div class="fw-bold" id="networkDisplay">
                  {{ network_info.chain|upper|replace("-", " ") }}
                </div>
              </div>
            </div>
            <div class="col-6">
              <div class="border rounded p-3 text-center">
                <small class="text-muted">Settlement</small>
                <div class="fw-bold">Atomic Split</div>
                <small class="text-muted" style="font-size: 0.7em"
                  >Instant</small
                >
              </div>
            </div>
          </div>

          <!-- Wallet Connection Section -->
          <div id="walletSection" class="mb-3">
            <div class="d-grid">
              <button id="connectBtn" class="btn btn-warning btn-lg">
                üîå Connect MetaMask
              </button>
            </div>
          </div>

          <!-- Payment Section (Hidden Initially) -->
          <div id="paymentSection" style="display: none" class="mb-3">
            <div class="wallet-connected mb-3 p-3 bg-light rounded">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <small class="text-muted">Connected Wallet</small>
                  <div id="walletAddress" class="fw-bold"></div>
                </div>
                <button
                  id="disconnectBtn"
                  class="btn btn-sm btn-outline-secondary"
                >
                  Disconnect
                </button>
              </div>
            </div>

            <div class="d-grid mb-2">
              <button id="payBtn" class="btn btn-success btn-lg">
                üí∞ Pay {{ (amount | float + 0.01) | round(2) }} USDC
              </button>
            </div>

            <!-- How it works -->
            <div class="alert alert-light border small">
              <div class="mb-2"><strong>‚ú® How it works:</strong></div>
              <ul class="mb-0 ps-3">
                <li>You sign one authorization (no gas fees!)</li>
                <li>
                  Payment splits automatically in ONE transaction:
                  <ul class="small">
                    <li>{{ amount }} ‚Üí Merchant</li>
                    <li>$0.01 ‚Üí 0xmeta (facilitator fee)</li>
                  </ul>
                </li>
                <li>All-or-nothing: Both succeed or both fail</li>
              </ul>
            </div>
          </div>

          <!-- Status Messages -->
          <div id="status" class="mt-3" aria-live="polite"></div>
        </div>

        <!-- Success Section with JSON Response (Hidden Initially) -->
        <div id="successSection" style="display: none">
          <!-- Verification Response -->
          <div id="verificationResponse" class="mb-4" style="display: none">
            <div class="response-header">
              <h5 class="mb-0">
                <span class="status-badge status-verified">
                  <span>‚úì</span>
                  <span>Payment Verified</span>
                </span>
              </h5>
              <button
                id="copyVerifyBtn"
                class="btn btn-sm btn-outline-secondary copy-btn"
              >
                üìã Copy JSON
              </button>
            </div>
            <div class="json-viewer" id="verifyJsonViewer"></div>
          </div>

          <!-- Settlement Response -->
          <div id="settlementResponse" class="mb-4" style="display: none">
            <div class="response-header">
              <h5 class="mb-0">
                <span class="status-badge status-settled">
                  <span>‚ö°</span>
                  <span>Settlement Executed</span>
                </span>
              </h5>
              <button
                id="copySettleBtn"
                class="btn btn-sm btn-outline-secondary copy-btn"
              >
                üìã Copy JSON
              </button>
            </div>
            <div class="json-viewer" id="settleJsonViewer"></div>
          </div>

          <!-- Action Buttons -->
          <div class="d-flex justify-content-center gap-2 mt-4">
            <button id="viewPhotosBtn" class="btn btn-primary">
              üñºÔ∏è View Premium Photos
            </button>
            <button id="tryAgainBtn" class="btn btn-outline-secondary">
              üîÑ Try Another Payment
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Enhanced app.js with JSON response display
  (function () {
    let verifyResponse = null;
    let settleResponse = null;

    // Syntax highlighting for JSON
    function syntaxHighlight(json) {
      if (typeof json !== "string") {
        json = JSON.stringify(json, null, 2);
      }
      json = json
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
      return json.replace(
        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        function (match) {
          let cls = "json-number";
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = "json-key";
            } else {
              cls = "json-string";
            }
          } else if (/true|false/.test(match)) {
            cls = "json-boolean";
          } else if (/null/.test(match)) {
            cls = "json-null";
          }
          return '<span class="' + cls + '">' + match + "</span>";
        }
      );
    }

    // Display JSON response
    function displayJsonResponse(containerId, data) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const highlighted = syntaxHighlight(data);
      container.innerHTML = `<pre>${highlighted}</pre>`;
    }

    // Copy JSON to clipboard
    function copyToClipboard(data) {
      const text = JSON.stringify(data, null, 2);
      navigator.clipboard
        .writeText(text)
        .then(() => {
          alert("‚úì JSON copied to clipboard!");
        })
        .catch((err) => {
          console.error("Copy failed:", err);
        });
    }

    // Show success section with responses
    function showSuccessWithResponses(verifyData, settleData) {
      // Hide payment flow
      document.getElementById("paymentFlow").style.display = "none";

      // Show success section
      const successSection = document.getElementById("successSection");
      successSection.style.display = "block";

      // Display verification response
      if (verifyData) {
        document.getElementById("verificationResponse").style.display = "block";
        displayJsonResponse("verifyJsonViewer", verifyData);
        verifyResponse = verifyData;
      }

      // Display settlement response
      if (settleData) {
        document.getElementById("settlementResponse").style.display = "block";
        displayJsonResponse("settleJsonViewer", settleData);
        settleResponse = settleData;
      }
    }

    // Bind copy buttons
    document.getElementById("copyVerifyBtn")?.addEventListener("click", () => {
      if (verifyResponse) copyToClipboard(verifyResponse);
    });

    document.getElementById("copySettleBtn")?.addEventListener("click", () => {
      if (settleResponse) copyToClipboard(settleResponse);
    });

    // View photos button
    document.getElementById("viewPhotosBtn")?.addEventListener("click", () => {
      window.location.href = "/photos";
    });

    // Try again button
    document.getElementById("tryAgainBtn")?.addEventListener("click", () => {
      window.location.reload();
    });

    // Expose to window for app.js to use
    window.showPaymentSuccess = showSuccessWithResponses;
  })();
</script>
{% endblock %} {% block scripts %}
<!-- Load Web3.js -->
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>

<!-- Settlement Status Polling Script -->
<script>
  /**
   * Poll settlement status until it's confirmed on-chain
   */
  async function pollSettlementStatus(
    settlementId,
    maxAttempts = 20,
    interval = 3000
  ) {
    console.log(`üîç Starting settlement status polling for ${settlementId}`);

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        const response = await fetch(
          `https://facilitator.0xmeta.ai/v1/settlements/${settlementId}/status`,
          { headers: { "Content-Type": "application/json" } }
        );

        if (!response.ok) {
          console.warn(
            `Attempt ${attempt}/${maxAttempts}: Failed to fetch status`
          );
          await sleep(interval);
          continue;
        }

        const status = await response.json();
        console.log(
          `Attempt ${attempt}/${maxAttempts}: Status =`,
          status.status
        );

        if (status.status === "settled" && status.transaction_hash) {
          console.log("‚úÖ Settlement confirmed on-chain!");
          updateSettlementStatus(status);
          return { success: true, status: status, attempts: attempt };
        }

        if (status.status === "failed") {
          console.error("‚ùå Settlement failed");
          return { success: false, status: status, attempts: attempt };
        }

        await sleep(interval);
      } catch (error) {
        console.error(`Attempt ${attempt}/${maxAttempts}: Error`, error);
        await sleep(interval);
      }
    }

    console.warn("‚ö†Ô∏è  Polling timeout");
    return { success: false, timeout: true, attempts: maxAttempts };
  }

  function sleep(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  function updateSettlementStatus(status) {
    const settlementViewer = document.getElementById("settleJsonViewer");
    if (settlementViewer && status) {
      const updatedData = {
        settlement_id: status.id,
        status: "settled",
        settlement_tx_hash: status.transaction_hash,
        settled_at: status.details?.settled_at || new Date().toISOString(),
        details: {
          ...status.details,
          confirmed_on_chain: true,
        },
      };

      const highlighted = syntaxHighlight(updatedData);
      settlementViewer.innerHTML = `<pre>${highlighted}</pre>`;

      const badge = document.querySelector(".status-settled");
      if (badge) {
        badge.style.background = "#d4edda";
        badge.style.color = "#155724";
        badge.innerHTML = "<span>‚úì</span><span>Confirmed On-Chain</span>";
      }
    }
  }

  function syntaxHighlight(json) {
    if (typeof json !== "string") {
      json = JSON.stringify(json, null, 2);
    }
    json = json
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
    return json.replace(
      /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
      function (match) {
        let cls = "json-number";
        if (/^"/.test(match)) {
          if (/:$/.test(match)) {
            cls = "json-key";
          } else {
            cls = "json-string";
          }
        } else if (/true|false/.test(match)) {
          cls = "json-boolean";
        } else if (/null/.test(match)) {
          cls = "json-null";
        }
        return '<span class="' + cls + '">' + match + "</span>";
      }
    );
  }

  window.pollSettlementStatus = pollSettlementStatus;
</script>

<!-- Load our app.js which handles payment logic -->
<script src="/static/js/app.js"></script>
{% endblock %}
